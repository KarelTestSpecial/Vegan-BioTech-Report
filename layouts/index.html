{{ define "main" }}
  <article class="pa3 pa4-ns nested-copy-line-height">
    <section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy {{ $.Param "text_color" | default "mid-gray" }}">
      {{- .Content -}}
    </section>

    {{/* Language Filter Controls are now in site-navigation.html */}}

    {{/* Verzamel en groepeer de live pagina's één keer */}}
    {{ $livePages := where .Site.RegularPages "Params.archived" "ne" true }}
    {{ $groupedPages := $livePages.GroupBy "Section" }}

    {{/* Definieer de volgorde van de secties */}}
    {{ $sectionOrder := slice "longreads" "newsletters" "posts" }}

    {{/* Loop over de gedefinieerde sectievolgorde */}}
    {{ range $sectionOrder }}
      {{ $sectionName := . }}
      {{ range $groupedPages }}
        {{ if eq .Key $sectionName }}
          <section class="flex-ns flex-wrap justify-around mt5">
            <div class="w-100">
              <h2 class="f2">{{ .Key | humanize | title }}</h2>
            </div>
            {{ range .Pages.ByDate.Reverse }}
              {{/* Determine language from frontmatter param */}}
              {{ $lang := default "unknown" .Params.language }}

              <div class="relative w-100 w-30-l mb4 bg-white article-item" data-language="{{ $lang }}">
                <div class="bg-white mb3 pa4 gray overflow-hidden">
                  {{ with .CurrentSection.Title }}<span class="f6 db">{{ . }}</span>{{ end }}
                  <h1 class="f3 near-black">
                    <a href="{{ .RelPermalink }}" class="link black dim">
                      {{ .Title }}
                    </a>
                  </h1>
                  <div class="nested-links f5 lh-copy nested-copy-line-height">
                    {{ .Summary }}
                  </div>
                  <a href="{{.RelPermalink}}" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">{{ $.Param "read_more_copy" | default (i18n "readMore") }}</a>
                </div>
              </div>
            {{ end }}
          </section>
        {{ end }}
      {{ end }}
    {{ end }}
  </article>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const langOptions = document.querySelectorAll('#language-switcher .lang-opt');
      const articles = document.querySelectorAll('.article-item');

      function updateVisibility(selectedLang) {
        articles.forEach(article => {
          const articleLang = article.getAttribute('data-language');
          
          if (selectedLang === 'all' || articleLang === selectedLang) {
            article.style.display = ''; // Show
          } else {
            article.style.display = 'none'; // Hide
          }
        });
      }

      langOptions.forEach(option => {
        option.addEventListener('click', function(event) {
          event.preventDefault();
          const selectedLang = this.dataset.value;

          // Update active styling
          langOptions.forEach(opt => {
            opt.classList.remove('white-90', 'fw6');
            opt.classList.add('white-50', 'fw3');
          });
          this.classList.remove('white-50', 'fw3');
          this.classList.add('white-90', 'fw6');

          updateVisibility(selectedLang);
        });
      });

      // Set initial active state and filter
      // Default to "All" being active, or previously saved preference
      const initialSelectedLang = localStorage.getItem('selectedLang') || 'all';
      const initialActiveOption = document.querySelector(`.lang-opt[data-value="${initialSelectedLang}"]`);
      if (initialActiveOption) {
        initialActiveOption.classList.remove('white-50', 'fw3');
        initialActiveOption.classList.add('white-90', 'fw6');
        updateVisibility(initialSelectedLang);
      } else {
        // Fallback if no initial preference or option found (shouldn't happen with default 'all')
        document.querySelector('.lang-opt[data-value="all"]').classList.add('white-90', 'fw6');
        updateVisibility('all');
      }
    });
  </script>
{{ end }}
