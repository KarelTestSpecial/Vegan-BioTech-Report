{{ define "main" }}
  <article class="pa3 pa4-ns nested-copy-line-height">
    <section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy {{ $.Param "text_color" | default "mid-gray" }}">
      {{- .Content -}}
    </section>

    {{/* Language Filter Controls are now in site-navigation.html */}}

    {{/* Verzamel en groepeer de live pagina's één keer */}}
    {{ $livePages := where .Site.RegularPages "Params.archived" "ne" true }}
    {{ $groupedPages := $livePages.GroupBy "Section" }}

    {{/* Definieer de volgorde van de secties */}}
    {{ $sectionOrder := slice "longreads" "newsletters" "posts" }}

    {{/* Loop over de gedefinieerde sectievolgorde */}}
    {{ range $sectionOrder }}
      {{ $sectionName := . }}
      {{ range $groupedPages }}
        {{ if eq .Key $sectionName }}
          <section class="flex-ns flex-wrap justify-around mt5">
            <div class="w-100">
              <h2 class="f2">{{ .Key | humanize | title }}</h2>
            </div>
            {{ range .Pages.ByDate.Reverse }}
              {{/* Determine language from frontmatter param */}}
              {{ $lang := default "unknown" .Params.language }}

              <div class="relative w-100 w-30-l mb4 bg-white article-item" data-language="{{ $lang }}">
                <div class="bg-white mb3 pa4 gray overflow-hidden">
                  {{ with .CurrentSection.Title }}<span class="f6 db">{{ . }}</span>{{ end }}
                  <h1 class="f3 near-black">
                    <a href="{{ .RelPermalink }}" class="link black dim">
                      {{ .Title }}
                    </a>
                  </h1>
                  <div class="nested-links f5 lh-copy nested-copy-line-height">
                    {{ .Summary }}
                  </div>
                  <a href="{{.RelPermalink}}" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">{{ $.Param "read_more_copy" | default (i18n "readMore") }}</a>
                </div>
              </div>
            {{ end }}
          </section>
        {{ end }}
      {{ end }}
    {{ end }}
  </article>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('lang-dropdown-toggle');
      const menu = document.getElementById('lang-dropdown-menu');
      const currentLabel = document.getElementById('current-lang-label');
      const langOptions = document.querySelectorAll('.lang-opt');
      const articles = document.querySelectorAll('.article-item');
      
      const labels = {
        'all': 'All Languages',
        'en': 'English',
        'nl': 'Nederlands'
      };

      // Helper to update filter and UI
      function setLanguage(lang) {
        // Update Filter
        articles.forEach(article => {
          const articleLang = article.getAttribute('data-language');
          if (lang === 'all' || articleLang === lang) {
            article.style.display = ''; 
          } else {
            article.style.display = 'none';
          }
        });

        // Update Button Text
        currentLabel.textContent = labels[lang] || 'All Languages';
        
        // Update LocalStorage
        localStorage.setItem('selectedLang', lang);
      }

      // Toggle Menu
      toggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        menu.classList.toggle('dn');
      });

      // Handle Selection
      langOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          const selectedLang = this.dataset.value;
          setLanguage(selectedLang);
          menu.classList.add('dn'); // Close menu
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!menu.contains(e.target) && !toggleBtn.contains(e.target)) {
          menu.classList.add('dn');
        }
      });

      // Initialize
      const savedLang = localStorage.getItem('selectedLang') || 'all';
      setLanguage(savedLang);
    });
  </script>
{{ end }}
